# ๐๏ธ ARQUITETURA DO SISTEMA - Controle de Gado

## ๐ Visรฃo Geral da Arquitetura

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         CAMADA DE ACESSO                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ          โ
โ  โ   Celular    โ  โ  Computador  โ  โ    Tablet    โ          โ
โ  โ  (Android/   โ  โ   Desktop    โ  โ    (iOS/     โ          โ
โ  โ    iOS)      โ  โ  (Browser)   โ  โ   Android)   โ          โ
โ  โโโโโโโโฌโโโโโโโโ  โโโโโโโโฌโโโโโโโโ  โโโโโโโโฌโโโโโโโโ          โ
โ         โ                  โ                  โ                   โ
โ         โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโ                   โ
โ                            โ                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      CAMADA DE APRESENTAรรO                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ              PWA - Progressive Web App                  โ     โ
โ  โ              (mobile_app.html)                         โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ
โ  โ  โข Interface Responsiva                                โ     โ
โ  โ  โข Instalรกvel como App Nativo                         โ     โ
โ  โ  โข Service Worker (Offline)                           โ     โ
โ  โ  โข Local Storage (Cache)                              โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โ HTTPS/REST
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      CAMADA DE SERVIDOR WEB                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ                   NGINX (Proxy Reverso)                โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ
โ  โ  โข Servir arquivos estรกticos (HTML/CSS/JS)            โ     โ
โ  โ  โข Proxy para API (/api/*)                            โ     โ
โ  โ  โข SSL/TLS Termination                                โ     โ
โ  โ  โข Load Balancing (se necessรกrio)                     โ     โ
โ  โ  โข Compressรฃo GZIP                                    โ     โ
โ  โ  โข Cache de estรกticos                                 โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                      โ                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                       โ
                       โ
                       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     CAMADA DE APLICAรรO (API)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ              FastAPI (Python 3.9+)                     โ     โ
โ  โ              (api_gado.py)                             โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ
โ  โ                                                         โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ  โ         MรDULOS DA API                        โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ     โ
โ  โ  โ  โข Autenticaรงรฃo JWT                          โ     โ     โ
โ  โ  โ  โข Gestรฃo de Animais                         โ     โ     โ
โ  โ  โ  โข Controle de Pesagens                      โ     โ     โ
โ  โ  โ  โข Gestรฃo de Sanidade                        โ     โ     โ
โ  โ  โ  โข Controle Reprodutivo                      โ     โ     โ
โ  โ  โ  โข Movimentaรงรตes                             โ     โ     โ
โ  โ  โ  โข Vendas e Despesas                         โ     โ     โ
โ  โ  โ  โข Relatรณrios e Analytics                    โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ                                                         โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ  โ         MIDDLEWARES                           โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ     โ
โ  โ  โ  โข CORS (Cross-Origin)                       โ     โ     โ
โ  โ  โ  โข Rate Limiting                             โ     โ     โ
โ  โ  โ  โข Logging                                   โ     โ     โ
โ  โ  โ  โข Error Handling                            โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ                                                         โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                       โ                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                        โ
                        โ psycopg2
                        โ
                        โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     CAMADA DE PERSISTรNCIA                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ              PostgreSQL 15                             โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ
โ  โ                                                         โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ  โ  TABELAS PRINCIPAIS                          โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ     โ
โ  โ  โ  โข animais         (dados cadastrais)       โ     โ     โ
โ  โ  โ  โข pesagens        (histรณrico de peso)      โ     โ     โ
โ  โ  โ  โข sanidade        (vacinas/medicamentos)   โ     โ     โ
โ  โ  โ  โข reproducao      (controle reprodutivo)   โ     โ     โ
โ  โ  โ  โข movimentacoes   (pastos/lotes)          โ     โ     โ
โ  โ  โ  โข vendas          (comercializaรงรฃo)        โ     โ     โ
โ  โ  โ  โข despesas        (custos)                 โ     โ     โ
โ  โ  โ  โข pastos          (infraestrutura)         โ     โ     โ
โ  โ  โ  โข lotes           (agrupamentos)           โ     โ     โ
โ  โ  โ  โข usuarios        (acesso ao sistema)      โ     โ     โ
โ  โ  โ  โข sessoes         (autenticaรงรฃo)           โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ                                                         โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ  โ  VIEWS E FUNรรES                             โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ     โ
โ  โ  โ  โข vw_rebanho_ativo                         โ     โ     โ
โ  โ  โ  โข vw_performance_animais (GMD)             โ     โ     โ
โ  โ  โ  โข vw_resumo_rebanho                        โ     โ     โ
โ  โ  โ  โข vw_aplicacoes_proximas                   โ     โ     โ
โ  โ  โ  โข calcular_gmd() (funรงรฃo)                  โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ                                                         โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     CAMADA DE AUTOMAรรO                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ  โ                      N8N Workflows                     โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ
โ  โ                                                         โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ  โ  Workflow 1: Relatรณrio Diรกrio                โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ     โ
โ  โ  โ  Trigger: Cron (8h da manhรฃ)                โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Query: Buscar dados do rebanho             โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Query: Prรณximas aplicaรงรตes                 โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Function: Formatar mensagem                โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Enviar: Email + WhatsApp                   โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ                                                         โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ  โ  Workflow 2: Alertas de Sanidade             โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ     โ
โ  โ  โ  Trigger: Cron (diรกrio)                     โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Query: Aplicaรงรตes vencidas/prรณximas        โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  IF: Tem alertas?                           โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Enviar: Notificaรงรฃo urgente                โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ                                                         โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ  โ  Workflow 3: Backup Automรกtico               โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค     โ     โ
โ  โ  โ  Trigger: Cron (semanal - domingo 2h)       โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Exec: pg_dump backup.sql                   โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Upload: Google Drive / S3                  โ     โ     โ
โ  โ  โ  โ                                           โ     โ     โ
โ  โ  โ  Enviar: Confirmaรงรฃo por email              โ     โ     โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ     โ
โ  โ                                                         โ     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ
โ                                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Fluxo de Dados

### 1. Cadastro de Animal

```
Usuรกrio (Mobile)
  โ [Preenche formulรกrio]
  โ [POST /api/animais]
FastAPI
  โ [Valida JWT]
  โ [Valida dados]
  โ [INSERT INTO animais]
PostgreSQL
  โ [Retorna ID]
  โ [INSERT INTO pesagens (peso inicial)]
  โ [Commit transaction]
FastAPI
  โ [Retorna sucesso]
Mobile
  โ [Exibe confirmaรงรฃo]
```

### 2. Registro de Pesagem

```
Usuรกrio (Mobile)
  โ [Busca animal por brinco]
  โ [GET /api/animais/brinco/{brinco}]
FastAPI
  โ [SELECT FROM animais]
PostgreSQL
  โ [Retorna dados]
Mobile
  โ [Exibe dados do animal]
  โ [Usuรกrio insere novo peso]
  โ [POST /api/pesagens]
FastAPI
  โ [INSERT INTO pesagens]
  โ [UPDATE animais SET peso_atual]
  โ [Calcula GMD]
PostgreSQL
  โ [Retorna sucesso + GMD]
Mobile
  โ [Exibe confirmaรงรฃo + GMD]
```

### 3. Relatรณrio Automรกtico

```
N8N (Cron: 8h)
  โ [Trigger: Schedule]
  โ [Query: vw_resumo_rebanho]
PostgreSQL
  โ [Retorna estatรญsticas]
  โ [Query: vw_aplicacoes_proximas]
  โ [Retorna prรณximas aplicaรงรตes]
N8N
  โ [Function: Formatar mensagem]
  โ [Enviar Email]
SMTP
  โ [Email enviado]
  โ [Enviar WhatsApp]
WhatsApp API
  โ [Mensagem enviada]
```

## ๐ Fluxo de Autenticaรงรฃo

```
1. Login
   Mobile โ POST /api/auth/login
   API โ Verifica credenciais no PostgreSQL
   API โ Gera JWT token
   API โ Salva sessรฃo na tabela 'sessoes'
   API โ Retorna token + dados do usuรกrio
   Mobile โ Armazena token no LocalStorage

2. Requisiรงรตes Autenticadas
   Mobile โ GET /api/animais
   Headers: Authorization: Bearer {token}
   API โ Verifica token na tabela 'sessoes'
   API โ Valida expiraรงรฃo
   API โ Executa query
   API โ Retorna dados

3. Logout
   Mobile โ POST /api/auth/logout
   API โ Remove sessรฃo do banco
   Mobile โ Remove token do LocalStorage
```

## ๐ฆ Deployment com Docker

```
docker-compose up
  โ
  โโโ [Container: postgres]
  โ   โโ Inicializa banco
  โ   โโ Executa schema SQL
  โ   โโ Aguarda conexรตes (porta 5432)
  โ
  โโโ [Container: api]
  โ   โโ Aguarda postgres estar healthy
  โ   โโ Instala dependรชncias Python
  โ   โโ Inicia FastAPI/Uvicorn
  โ   โโ Escuta na porta 8000
  โ
  โโโ [Container: nginx]
  โ   โโ Aguarda api estar rodando
  โ   โโ Serve arquivos estรกticos (port 80)
  โ   โโ Proxy reverso para API
  โ
  โโโ [Container: n8n]
      โโ Aguarda postgres estar healthy
      โโ Conecta ao banco
      โโ Importa workflows
      โโ Escuta na porta 5678

Sistema completo rodando! โ
```

## ๐ Topologia de Rede

```
Internet
  โ
  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      Firewall/Router         โ
โ  Porta 80 (HTTP)             โ
โ  Porta 443 (HTTPS)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ
  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Nginx                โ
โ  :80 โ Frontend (HTML)       โ
โ  :80/api โ Proxy โ API       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ
  โโโ [FastAPI :8000]
  โ     โ
  โ     โโโ [PostgreSQL :5432]
  โ
  โโโ [N8N :5678]
        โ
        โโโ [PostgreSQL :5432]
```

## ๐ Estrutura de Dados (Diagrama ER Simplificado)

```
usuarios โโโโ
            โ
            โโโ sessoes (1:N)
            โ
            โโโ [usa sistema]


animais โโโโโโฌโโ pesagens (1:N)
  โ          โ
  โ          โโโ sanidade (1:N)
  โ          โ
  โ          โโโ movimentacoes (1:N)
  โ          โ
  โ          โโโ vendas (1:1)
  โ          โ
  โ          โโโ reproducao (1:N)
  โ
  โโโ pai_id (FK โ animais)
  โ
  โโโ mae_id (FK โ animais)


lotes โโโโ animais.lote (1:N)

pastos โโโ animais.pasto (1:N)

despesas โ animal_id (N:1)
```

## ๐ก๏ธ Camadas de Seguranรงa

```
1. Rede
   โโ Firewall (portas especรญficas)
   โโ SSL/TLS (HTTPS)
   โโ Rate Limiting

2. Aplicaรงรฃo
   โโ JWT Authentication
   โโ Password Hashing (SHA256)
   โโ Input Validation (Pydantic)
   โโ SQL Injection Protection (Parametrized Queries)
   โโ CORS Configuration

3. Banco de Dados
   โโ User Permissions
   โโ Connection Pooling
   โโ Encrypted Connections

4. Infraestrutura
   โโ Container Isolation (Docker)
   โโ Environment Variables (.env)
   โโ Backup Automรกtico
   โโ Logs Centralizados
```

## ๐ Escalabilidade

### Vertical (Mesma Mรกquina)
```
1 usuรกrio  โ 1 container  โ 1GB RAM
10 usuรกrios โ 1 container  โ 2GB RAM
50 usuรกrios โ 1 container  โ 4GB RAM
```

### Horizontal (Mรบltiplas Mรกquinas)
```
Load Balancer
  โ
  โโโ API Instance 1
  โโโ API Instance 2
  โโโ API Instance 3
       โ
       โโโ PostgreSQL (Master/Replica)
```

## ๐ Ciclo de Vida dos Dados

```
1. ENTRADA
   Usuรกrio โ Interface โ API โ Banco

2. PROCESSAMENTO
   Banco โ Views โ Cรกlculos (GMD, mรฉdias)

3. ANรLISE
   Banco โ API โ Relatรณrios โ Usuรกrio

4. AUTOMAรรO
   Banco โ N8N โ Notificaรงรตes โ Usuรกrio

5. BACKUP
   Banco โ pg_dump โ Storage โ Seguranรงa
```

---

**Arquitetura Moderna, Escalรกvel e Segura** ๐๏ธ
